<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let dataChart;
        let dataChart_hr;
        let timeLabels = [];
        let timeLabels_hr = [];
        let pm25 = [];
        let pm100 = [];
        let pm25_hr = [];
        let pm100_hr = [];
        window.onload = function() {
                fetch('/history')
                        .then(response => response.json())
                        .then (database => {
                                if (database.length > 0) {
                                        database.forEach((entry, index) => {
                                                let entrytimeserver = new Date(entry["time"]);
                                                timeLabels.push(entrytimeserver.toLocaleString());
                                                pm25.push(entry.pm25);
                                                pm100.push(entry.pm100);

                                        });

                                        dataChart.data.labels = timeLabels;
                                        dataChart.data.datasets[0].data = pm25;
                                        dataChart.data.datasets[1].data = pm100;
                                        dataChart.update();
                                }
                        }).catch(error => console.error("Could not load database:", error));

                fetch('/history_hr')
                        .then(response_hr => response_hr.json())
                        .then (database_hr => {
                                if (database_hr.length > 0) {
                                        database_hr.forEach((entry, index) => {
                                                let entrytimeserver = new Date(entry["time"]);
                                                timeLabels_hr.push(entrytimeserver.toLocaleString());
                                                pm25_hr.push(entry.pm25_hr);
                                                pm100_hr.push(entry.pm100_hr)
                                        });

                                        dataChart_hr.data.labels = timeLabels_hr;
                                        dataChart_hr.data.datasets[0].data = pm25_hr;
                                        dataChart_hr.data.datasets[1].data = pm100_hr;
                                        dataChart_hr.update();
                                }
                        }).catch(error => console.error("Could not load database:", error));

                const ctx = document.getElementById('Chart').getContext('2d')
                dataChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                                labels: [],
                                datasets: [
                                        {
                                                label: 'PM 2.5',
                                                fill: false,
                                                data: [],
                                                borderColor: 'grey',
                                                backgroundColor: 'grey',
                                                segment: {
                                                        borderColor: ctx => {
                                                                const y = ctx.p1.parsed.y;

                                                                if (y > 301) return 'maroon';
                                                                if (y > 201) return 'purple';
                                                                if (y > 151) return 'red';
                                                                if (y > 101) return 'orange';
                                                                if (y > 51) return 'yellow';
                                                                return 'green';
                                                        }
                                                },
                                                pointBackgroundColor: 'grey',
                                                pointBorderColor: 'grey',
                                                tension: 0.5
                                        },
                                        {
                                                label: 'PM 10.0',
                                                fill: false,
                                                data: [],
                                                borderColor: 'black',
                                                backgroundColor: 'black',
                                                segment: {
                                                        borderColor: ctx => {
                                                        const y = ctx.p1.parsed.y;

                                                        if (y > 301) return 'maroon';     
                                                        if (y > 201) return 'purple';     
                                                        if (y > 151) return 'red';
                                                        if (y > 101) return 'orange';
                                                        if (y > 51) return 'yellow';
                                                        return 'green';
                                                        }
                                                },
                                                pointBackgroundColor: 'black',
                                                pointBorderColor: 'black',
                                                tension: 0.5
                                        }

                                ]
                        },
                        options: {
                                responsive : true,
                                scales: {
                                        x: { title: { display: true, text: 'Time' } },
                                        y: { title: { display: true, text: 'AQI level' }, beginAtZero: true }
                                }
                        }
                });

                const ctx2 = document.getElementById('Chart_hr').getContext('2d')
                dataChart_hr = new Chart(ctx2, {
                        type: 'line',
                        data: {
                                labels: [],
                                datasets: [
                                        {
                                                label: 'PM 2.5',
                                                fill: false,
                                                data: [],
                                                borderColor: 'grey',
                                                backgroundColor: 'grey',
                                                segment: {
                                                        borderColor: ctx => {
                                                                const y = ctx.p1.parsed.y;

                                                                if (y > 301) return 'maroon';
                                                                if (y > 201) return 'purple';
                                                                if (y > 151) return 'red';
                                                                if (y > 101) return 'orange';
                                                                if (y > 51) return 'yellow';
                                                                return 'green';
                                                        }
                                                },
                                                pointBackgroundColor: 'grey',
                                                pointBorderColor: 'grey',
                                                tension: 0.5
                                        },
                                        {
                                                label: 'PM 10.0',
                                                fill: false,
                                                data: [],
                                                borderColor: 'black',
                                                backgroundColor: 'black',
                                                segment: {
                                                        borderColor: ctx => {
                                                        const y = ctx.p1.parsed.y;
                                                        
                                                        if (y > 301) return 'maroon';     
                                                        if (y > 201) return 'purple';     
                                                        if (y > 151) return 'red';
                                                        if (y > 101) return 'orange';
                                                        if (y > 51) return 'yellow';
                                                        return 'green';
                                                        }
                                                },
                                                pointBackgroundColor: 'black',
                                                pointBorderColor: 'black',
                                                tension: 0.5
                                        }

                                ]
                        },


                        options: {
                                responsive : true,
                                scales: {
                                        x: { title: { display: true, text: 'Time' } },
                                        y: { title: { display: true, text: 'AQI level' }, beginAtZero: true }
                                }
                        }
               });
        };
    </script>
    <style>


    </style>
</head>
<body>
    <h1>Air Quality Data</h1>
    <a href=https://www.airnow.gov/aqi/aqi-basics/>Info on safe levels can be found here</a>
    <canvas id="Chart" width="1920" height="1080"></canvas>
    <canvas id="Chart_hr" width="1920" height="1080"></canvas>
</body>
</html>
